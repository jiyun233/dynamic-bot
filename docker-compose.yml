version: '3.8'

services:
  dynamic-bot:
    # 构建配置
    build:
      context: .
      dockerfile: Dockerfile
      args:
        APP_VERSION: 1.6

    # 镜像标签
    image: dynamic-bot:1.6

    # 容器名称
    container_name: dynamic-bot

    # 重启策略
    restart: unless-stopped

    # 环境变量
    # 注意: JVM 内存参数已在 Dockerfile 中通过 JAVA_TOOL_OPTIONS 和 CMD 配置
    # 不要在这里设置 JAVA_OPTS，否则会覆盖优化配置
    environment:
      - TZ=Asia/Shanghai

    # 数据卷挂载
    volumes:
      - ./config:/app/config   # 配置文件 (bot.yml, config.yml, data.yml)
      - ./data:/app/data       # 数据目录 (cache/, image_cache/, font/, exception/)
      - ./temp:/app/temp       # 临时文件 (帮助图片等)
      - ./logs:/app/logs       # 日志目录 (daemon/)

    # 网络模式
    network_mode: "bridge"

    # 资源限制 - 基于优化后的内存预算 (目标 300-400MB)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M    # 硬限制，留有余量
        reservations:
          cpus: '0.5'
          memory: 256M    # 最小保证

    # 共享内存配置 (Xvfb 1920x1080x24 需要约 8MB，256m 足够)
    shm_size: 256m

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
